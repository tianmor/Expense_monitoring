<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Expense Monitoring System</title>
  <link rel="stylesheet" href="style.css" />

  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* Added budget section & progress bar styling */
    .budget {
      margin-bottom: 20px;
    }

    .progress-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 10px;
      margin-top: 5px;
    }

    #budgetProgress {
      width: 0%;
      height: 20px;
      background-color: #4caf50;
      border-radius: 10px;
      text-align: center;
      color: white;
      font-size: 12px;
      line-height: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ’° Expense Monitoring System</h1>

    <!-- Budget Section -->
    <div class="budget">
      <h3>ðŸ’µ Total Budget</h3>
      <input id="budgetInput" type="number" placeholder="Enter your total budget" />
      <p>Remaining Balance: â‚±<span id="remainingBalance">0</span></p>
      <div class="progress-container">
        <div id="budgetProgress">0%</div>
      </div>
    </div>

    <!-- Add/Edit Expense Form -->
    <div class="form">
      <h3>Add Expense</h3>
      <input id="categoryInput" placeholder="Category (e.g. Food)" />
      <input id="amountInput" type="number" placeholder="Amount" />
      <input id="descInput" placeholder="Description" />
      <input id="dateInput" type="date" />
      <button id="submitButton" onclick="submitExpense()">Add Expense</button>
    </div>

    <h3>Expenses List</h3>
    <ul id="expenseList"></ul>
  </div>

  <script>
    const api = "http://localhost:3000/expenses";
    let editingId = null;
    let totalBudget = parseFloat(localStorage.getItem("totalBudget")) || 0;

    document.getElementById("budgetInput").value = totalBudget;

    // Update total budget input
    document.getElementById("budgetInput").addEventListener("input", (e) => {
      totalBudget = parseFloat(e.target.value) || 0;
      localStorage.setItem("totalBudget", totalBudget);
      updateRemainingBalance();
    });

    // Fetch and display expenses
    function getExpenses() {
      fetch(api)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("expenseList");
          list.innerHTML = "";

          data.forEach(exp => {
            const formattedDate = new Date(exp.date).toISOString().split("T")[0];

            const li = document.createElement("li");
            li.innerHTML = `
              <span>
                <strong>${exp.category}</strong> - â‚±${exp.amount}
                <em>(${formattedDate})</em> : ${exp.description}
              </span>
              <div class="actions">
                <button class="update" onclick="editExpense(${exp.id})">Update</button>
                <button class="delete" onclick="deleteExpense(${exp.id})">Delete</button>
              </div>
            `;
            list.appendChild(li);
          });

          updateRemainingBalance();
          updateProgressBar();
        });
    }

    // Add or update expense
    function submitExpense() {
      const category = document.getElementById("categoryInput").value.trim();
      const amount = parseFloat(document.getElementById("amountInput").value.trim());
      const description = document.getElementById("descInput").value.trim();
      const date = document.getElementById("dateInput").value;

      if (!category || !amount || !date) {
        Swal.fire("Missing Fields", "Please fill all required fields.", "warning");
        return;
      }

      // Check budget
      fetch(api)
        .then(res => res.json())
        .then(data => {
          const spent = data.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
          const remaining = totalBudget - spent;

          


          if (!editingId && amount > remaining) {
            Swal.fire("Budget Exceeded", "This expense exceeds your remaining funds.", "error");
            return;
          }

          const method = editingId ? "PUT" : "POST";
          const url = editingId ? `${api}/${editingId}` : api;

          fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ category, amount, description, date })
          }).then(() => {
            Swal.fire(editingId ? "Updated!" : "Added!", `Expense ${editingId ? "updated" : "added"} successfully.`, "success");
            editingId = null;
            clearForm();
            getExpenses();
          });
        });
    }

    // Load expense into form for editing
    function editExpense(id) {
      fetch(`${api}/${id}`)
        .then(res => res.json())
        .then(exp => {
          document.getElementById("categoryInput").value = exp.category;
          document.getElementById("amountInput").value = exp.amount;
          document.getElementById("descInput").value = exp.description;
          document.getElementById("dateInput").value = new Date(exp.date).toISOString().split("T")[0];

          editingId = id;
          document.getElementById("submitButton").innerText = "Update Expense";
        });
    }

    // Delete expense
    function deleteExpense(id) {
      Swal.fire({
        title: "Are you sure?",
        text: "This expense will be permanently deleted.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it!"
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`${api}/${id}`, { method: "DELETE" }).then(() => {
            Swal.fire("Deleted!", "The expense has been removed.", "success");
            getExpenses();
          });
        }
      });
    }

    // Clear form
    function clearForm() {
      document.getElementById("categoryInput").value = "";
      document.getElementById("amountInput").value = "";
      document.getElementById("descInput").value = "";
      document.getElementById("dateInput").value = "";
      editingId = null;
      document.getElementById("submitButton").innerText = "Add Expense";
    }

    // Update remaining balance
    function updateRemainingBalance() {
      fetch(api)
        .then(res => res.json())
        .then(data => {
          const spent = data.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
          const remaining = totalBudget - spent;

          const remainingElem = document.getElementById("remainingBalance");
          remainingElem.innerText = remaining.toFixed(2);
          remainingElem.style.color = remaining < 0 ? "#ff5c5c" : "#333"; // red if over budget
        });
    }


    // Update budget progress bar
    function updateProgressBar() {
      fetch(api)
        .then(res => res.json())
        .then(data => {
          const spent = data.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
          const percent = totalBudget ? (spent / totalBudget) * 100 : 0;

          const bar = document.getElementById("budgetProgress");
          bar.style.width = Math.min(percent, 100) + "%";
          bar.innerText = `${Math.round(percent)}%`;

          // Change color based on usage
          if (percent < 80) {
            bar.style.backgroundColor = "#4caf50"; // green
          } else if (percent >= 80 && percent <= 100) {
            bar.style.backgroundColor = "#ffa500"; // orange
          } else {
            bar.style.backgroundColor = "#ff5c5c"; // red
          }
        });
    }


    // Initialize
    getExpenses();
  </script>
</body>
</html>
